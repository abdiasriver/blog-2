# 自定义元素

> _pengzhanbo | 2018-03-22_
____

在web应用开发中，HTML标签为我们提供了基础的应用结构和交互，我们使用HTML标签构建了丰富的web应用。但是，我们在开发web应用的过程中，进行复杂的组件开发，很容易就会陷入 `div` 标签堆砌，逐渐丢失了HTML语义化的特性。

在HTML5标准中，虽然也增加了不少包括 `<header>`、`<section>`、`<article>`、`<nav>`、`<container>`、`<footer>` 等更加语义化的标签，但它们更多的，是为内容而添加的语义化标签，在实际的使用场景中，并不能完全满足我们的需求。那么，假如有一种方式，能够让我们创建我们自己的标签，可以随意的选择满足我们使用场景的标签会是怎样？甚至可以扩展已有标签的特性会是怎样？ 

__自定义元素（custom Elements）__ 能够帮助我们做到这些！

### 什么是自定义元素

> 自定义元素能够帮助web开发者创建拥有自身特性的自定义标签。

### 创建自定义元素

使用`document.registerElement()` 创建自定义元素
``` javascript
var MyTag = document.registerElement('my-tag');
```
现在，你就可以在文档的任何位置使用你的标签了
``` html
<my-tag></my-tag>
```
我们也可以使用命令式创建自定义元素
``` javascript
var MyTag = document.registerElement('my-tag');
document.body.appendChild(new MyTag());
```
或者
``` javascript
var MyTag = document.registerElement('my-tag');
var myTag = document.createElement('my-tag');
document.body.appendChild(myTag);
```

__自定义元素命名规则__

名称必须包含至少一个 “-”,任何不含“-”的自定义标签都会导致错误。例如，`my-tag`，`my-list-item` 为合法标签，`my_tag`、`myTag` 都是非法的自定义标签名称。

### 添加自定义元素特性
`document.registerElement()` 的第二个参数允许我们为自定义元素添加新的特性。

在说明如何添加新的特性之前，需要先了解 `HTMLElement` 。

`HTMLElement` 对象表示HTML中的一个元素，继承了`Node`和`Element`对象的标准属性。 可前往 [HTMLElement](http://www.w3school.com.cn/xmldom/dom_htmlelement.asp) 了解。

我们通过 `HTMLElement.prototype` 调用 `Object.create()` 创建一个基本的原型，该原型上已定义好HTML的基本属性，我们可以在改该原型新增属性和方法，添加特性。

``` javascript
var proto = Object.create(HTMLElement.prototype);
proto.hello = 'hello';
proto.sayHello = function () {
    alert(this.hello);
};
var MyTag = document.registerElement('my-tag', {
    prototype: proto
});
```

### 扩展原生元素特性
`document.registerElement()` 的第二个参数还允许我们为扩展原生素的特性。

扩展原生元素的特性，并不是都是使用`HTMLElement.prototype`，而是使用该元素的原型对象去扩展特性。比如，扩展`button`元素
``` javascript
var MyButton = document.registerElement('my-button', {
    extend: 'button',
    prototpye: Object.create(HTMLButtonElement.prototype)
});
```
这类自定义元素被称为类型扩展自定义元素。
``` html
<button is="my-button"><button>
```
从表现来看，这类自定义元素，表示继承自某个特性的元素原型，表达了 元素`button`是扩展元素`my-button`。

### 生命周期以及回调方法

在我们创建自定义元素，到使用自定义元素，到从文档中删除自定义元素，都有对应的生命周期以及回调方法。

1. createdCallback(): 元素创建后回调。
2. attachCallback(): 元素附加到文档后调用。
3. detachCallback(): 元素从文档移除后调用。
4. attributeChangedCallback(): 元素任意属性变化后调用。

``` html
<my-tag></my-tag>
```
``` javascript
var myTagProto = Object.create(HTMLElement.prototype);

myTagProto.createdCallback = function() {
    // 元素创建后回调。
    this.textContent = '我被创建了';
};

var MyTag = document.registerElement('my-tag', {
    prototype: myTagProto
});
```


### 通过`customElements` 创建自定义元素

Custom Element API 规范进一步升级，定义了`customElements`作为统一的对象管理自定义元素，并对ES6 class提供了更完善的支持。

使用`customElements`创建自定义元素的简单例子：
``` javascript
class MyTag extends HTMLElement {
    constructor() {
        super();
        this._name = '';
    }
    static get observedAttributed() {
        return ['name'];
    }
    get name() {
        reutrn this._name;
    }
    set name(value) {
        this.setAttribute('name', value);
    }
    _update() {
        this.textContent = this._name;
    }
    attributeChangedCallback(name, oldValue, newValue) {
        this._name = newValue;
        this._update();
    }
}
customElements.define("my-tag", MyTag);
```

新建自定义元素类同样需要继承自`HTMLElement`，且需要调用 `super()` 执行父类构造函数。并使用`customElements.define()` API 完成自定义元素的注册。接着，我们就可以在文档中使用该自定义元素(包括在定义之前)。
``` html
<my-tag></my-tag>
```

我们从一个完整的例子来说明生命周期以及关键属性：
``` javascript
class MyCustom extends HTMLElement {
    // 自定义元素开始提升时调用
    // 元素提升并不说明元素已插入到文档中
    // 在此阶段尽量避免进行DOM操作
    constructor() {
        super();
        this._name = '';
    }
    // 定义需要观察的属性
    static get observedAttributed() {
        return ['name'];
    }
    // 元素插入到文档时回调
    // 相当于 registerElement 中的 attachedCallback
    connectedCallback() {
        // do something...
    }
    // 元素从文档中删除时回调
    // 相当于 registerElement 中的 detachCallback
    discannectedCallback() {
        // do something...
    }
    /*
     * 元素属性变化回调
     * 如果 observedAttributed 有值，则监听 observedAttributed 定义的属性变化，
     * 如果 observedAttributed 为空，这监听所有属性变化
     * @param name {string} 变化的属性名
     * @param oldValue {any} 变化前的值
     * @param newVlalue {any} 变化后的值
     */
    attributeChangedCallback(name, oldValue, newValue) {
        // do something...
    }
    // 元素被移动到新的文档中时调用
    // （When it is adopted into a new document, its adoptedCallback is run.）
    // 具体场景：通过document.adoptNode方法修改元素ownerDocument属性时触发
    adoptedCallback() {
        // do something...
    }
}
customElements.define("my-custom", MyCustom);
```

- `customElements.whenDefined(tagName)` 监听自定义元素是否已完成定义，并返回一个 `Promise`  。
- `customElements.get(tagName)` 获取自定义元素原型，否则返回`undefined`。
